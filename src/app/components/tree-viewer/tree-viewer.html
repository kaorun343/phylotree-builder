<div class="tree-viewer">
  <svg
    [attr.width]="svgWidth()"
    [attr.height]="svgHeight()"
    [class]="treeSvgClass"
    (click)="onSvgClick($event)"
  >
    <!-- Draw branches -->
    <g class="branches" [attr.transform]="marginTransform()">
      <!-- Root branch (always shown) -->
      @if (rootBranch()) {
      <line
        [attr.x1]="rootBranch()!.start.x"
        [attr.y1]="rootBranch()!.start.y"
        [attr.x2]="rootBranch()!.end.x"
        [attr.y2]="rootBranch()!.end.y"
        class="branch root-branch"
        stroke="#666"
        stroke-width="2"
        fill="none"
      ></line>
      } @for (branch of visibleBranches(); track branch.id) {
      <path
        [attr.d]="branch | branchPath"
        class="branch"
        [attr.stroke]="branch.child.color || '#666'"
        stroke-width="2"
        fill="none"
        [style.cursor]="currentMode() === 'author' ? 'pointer' : 'default'"
        (click)="onEdgeClick(branch.child, $event)"
      ></path>
      }
    </g>

    <!-- Draw nodes -->
    <g class="nodes" [attr.transform]="marginTransform()">
      @for (node of visualNodes(); track node.id) {
      <!-- Selection indicator (behind node) - Only in Author mode -->
      @if (currentMode() === 'author' && isNodeSelected()(node.id)) {
      <circle
        [attr.cx]="node.position.x"
        [attr.cy]="node.position.y"
        [attr.r]="getNodeRadius()(node) + 3"
        class="selection-ring"
      ></circle>
      }

      <!-- Node circle - Only in Author mode -->
      @if (currentMode() === 'author') {
      <circle
        [attr.cx]="node.position.x"
        [attr.cy]="node.position.y"
        [attr.r]="getNodeRadius()(node)"
        [attr.class]="getNodeClasses()(node)"
        [attr.fill]="getNodeStyles()(node)['fill']"
        [attr.stroke]="getNodeStyles()(node)['stroke']"
        [attr.stroke-width]="getNodeStyles()(node)['stroke-width']"
        [style.cursor]="getNodeStyles()(node)['cursor']"
        (click)="onNodeClick(node, $event)"
      ></circle>
      }

      <!-- Node label -->
      <text
        [attr.x]="getNodeLabelPosition(node).x"
        [attr.y]="getNodeLabelPosition(node).y"
        [attr.text-anchor]="getNodeLabelTextAnchor()"
        class="node-label"
        [class.selected-label]="
          currentMode() === 'author' && isNodeSelected()(node.id)
        "
        font-family="monospace"
        font-size="12"
        [attr.fill]="
          currentMode() === 'author' && isNodeSelected()(node.id)
            ? '#ff9800'
            : '#333'
        "
        [attr.font-weight]="
          currentMode() === 'author' && isNodeSelected()(node.id)
            ? 'bold'
            : 'normal'
        "
        [style.cursor]="currentMode() === 'author' ? 'pointer' : 'default'"
        style="user-select: none"
        (click)="onNodeClick(node, $event)"
      >
        {{ node.name }}
      </text>
      }
    </g>

    <!-- Draw branch length labels - Only in Author mode -->
    @if (currentMode() === 'author') {
    <g class="branch-labels" [attr.transform]="marginTransform()">
      @for (branch of visibleBranches(); track branch.id) { @if
      (branch.child.branchLength) {
      <text
        [attr.x]="getBranchLabelX(branch)"
        [attr.y]="getBranchLabelY(branch)"
        class="branch-length-label"
        [attr.text-anchor]="getBranchLabelTextAnchor()"
        [attr.dominant-baseline]="getBranchLabelBaseline(branch)"
        font-family="monospace"
        font-size="10"
        fill="#666"
        style="user-select: none; pointer-events: none"
      >
        {{ branch.child.branchLength }}
      </text>
      } }
    </g>
    }
  </svg>
</div>
