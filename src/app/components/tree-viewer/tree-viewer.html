<div class="tree-viewer">
  <svg
    [attr.width]="svgWidth()"
    [attr.height]="svgHeight()"
    class="tree-svg"
    (click)="onSvgClick($event)"
  >
    <!-- Draw branches -->
    <g class="branches" [attr.transform]="marginTransform()">
      @for (branch of visibleBranches(); track branch.id) {
      <path
        [attr.d]="branch | branchPath"
        class="branch"
        [attr.stroke]="branch.child.color || '#666'"
        stroke-width="2"
        fill="none"
        (click)="onEdgeClick(branch.child, $event)"
      ></path>
      }
    </g>

    <!-- Draw nodes -->
    <g class="nodes" [attr.transform]="marginTransform()">
      @for (node of visualNodes(); track node.id) {
      <!-- Selection indicator (behind node) -->
      @if (isNodeSelected()(node.id)) {
      <circle
        [attr.cx]="node.position.x"
        [attr.cy]="node.position.y"
        [attr.r]="getNodeRadius()(node) + 3"
        class="selection-ring"
      ></circle>
      }

      <!-- Node circle -->
      <circle
        [attr.cx]="node.position.x"
        [attr.cy]="node.position.y"
        [attr.r]="getNodeRadius()(node)"
        [attr.class]="getNodeClasses()(node)"
        (click)="onNodeClick(node, $event)"
      ></circle>

      <!-- Node label -->
      <text
        [attr.x]="node.position.x + 10"
        [attr.y]="node.position.y + 5"
        class="node-label"
        [class.selected-label]="isNodeSelected()(node.id)"
      >
        {{ node.name }}
      </text>
      }
    </g>

    <!-- Draw branch length labels -->
    <g class="branch-labels" [attr.transform]="marginTransform()">
      @for (branch of visibleBranches(); track branch.id) {
      @if (branch.child.branchLength) {
      <text
        [attr.x]="getBranchLabelX(branch)"
        [attr.y]="getBranchLabelY(branch)"
        class="branch-length-label"
        [attr.text-anchor]="'middle'"
        [attr.dominant-baseline]="getBranchLabelBaseline(branch)"
      >
        {{ branch.child.branchLength }}
      </text>
      }
      }
    </g>
  </svg>
</div>
